#!/bin/bash
set -e

# Configuration
PORT=62996
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GOOSED_URL="https://github.com/michaelneale/goose-tunnel/releases/download/test/goosed"
GOOSED_LOCAL_PATH="${SCRIPT_DIR}/goosed"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

SECRET="test"

# Function to download goosed binary with LOUD notification
download_goosed() {
    echo ""
    echo -e "${BOLD}${MAGENTA}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘                   ğŸš€  DOWNLOADING GOOSED BINARY  ğŸš€                   â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${MAGENTA}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}â¬‡ï¸  Fetching from: ${GOOSED_URL}${NC}"
    echo -e "${BOLD}${CYAN}ğŸ“¦ Saving to: ${GOOSED_LOCAL_PATH}${NC}"
    echo ""
    
    if curl -L -o "$GOOSED_LOCAL_PATH" "$GOOSED_URL"; then
        chmod +x "$GOOSED_LOCAL_PATH"
        echo ""
        echo -e "${BOLD}${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BOLD}${GREEN}â•‘                                                                       â•‘${NC}"
        echo -e "${BOLD}${GREEN}â•‘                  âœ…  DOWNLOAD SUCCESSFUL!  âœ…                         â•‘${NC}"
        echo -e "${BOLD}${GREEN}â•‘                                                                       â•‘${NC}"
        echo -e "${BOLD}${GREEN}â•‘              goosed binary is now available locally!                  â•‘${NC}"
        echo -e "${BOLD}${GREEN}â•‘                                                                       â•‘${NC}"
        echo -e "${BOLD}${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        sleep 1  # Pause so user can see the message
        return 0
    else
        echo ""
        echo -e "${BOLD}${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
        echo -e "${BOLD}${RED}â•‘                                                                       â•‘${NC}"
        echo -e "${BOLD}${RED}â•‘                    âŒ  DOWNLOAD FAILED!  âŒ                           â•‘${NC}"
        echo -e "${BOLD}${RED}â•‘                                                                       â•‘${NC}"
        echo -e "${BOLD}${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
        echo ""
        return 1
    fi
}

# Determine which goosed to use
GOOSED_CMD=""
if command -v goosed &> /dev/null; then
    # Found in PATH
    GOOSED_CMD="goosed"
    echo ""
    echo -e "${BOLD}${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${BLUE}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${BLUE}â•‘                   ğŸ“  USING GOOSED FROM PATH  ğŸ“                      â•‘${NC}"
    echo -e "${BOLD}${BLUE}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ“‚ Location: $(which goosed)${NC}"
    echo ""
elif [ -f "$GOOSED_LOCAL_PATH" ]; then
    # Found locally
    GOOSED_CMD="$GOOSED_LOCAL_PATH"
    echo ""
    echo -e "${BOLD}${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BOLD}${YELLOW}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${YELLOW}â•‘                  ğŸ“¦  USING LOCAL GOOSED BINARY  ğŸ“¦                    â•‘${NC}"
    echo -e "${BOLD}${YELLOW}â•‘                                                                       â•‘${NC}"
    echo -e "${BOLD}${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}ğŸ“‚ Location: $GOOSED_LOCAL_PATH${NC}"
    echo ""
else
    # Not found anywhere - download it
    if download_goosed; then
        GOOSED_CMD="$GOOSED_LOCAL_PATH"
    else
        echo -e "${RED}Error: Failed to download goosed${NC}"
        echo -e "${YELLOW}Please manually download from: ${GOOSED_URL}${NC}"
        echo -e "${YELLOW}Or add goose/target/release to your PATH${NC}"
        exit 1
    fi
fi

# Cleanup function
cleanup() {
    echo -e "\n${YELLOW}Shutting down...${NC}"
    if [ ! -z "$GOOSED_PID" ]; then
        echo "Stopping goosed (PID: $GOOSED_PID)"
        kill $GOOSED_PID 2>/dev/null || true
    fi
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Start goosed in the background
echo -e "${GREEN}Starting goosed on port ${PORT}...${NC}"
export GOOSE_PORT=$PORT
export GOOSE_SERVER__SECRET_KEY="$SECRET"
$GOOSED_CMD agent &
GOOSED_PID=$!

# Wait for goosed to be ready
echo "Waiting for goosed to start..."
for i in {1..30}; do
    if curl -s "http://localhost:${PORT}/health" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“ Goosed is running (PID: $GOOSED_PID)${NC}"
        break
    fi
    if [ $i -eq 30 ]; then
        echo -e "${RED}Error: goosed failed to start${NC}"
        exit 1
    fi
    sleep 0.5
done

echo ""
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘                     Connection Information                         â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""
echo -e "${GREEN}URL:${NC}        http://localhost:${PORT}"
echo -e "${GREEN}Secret Key:${NC} $SECRET"
echo ""
echo -e "${GREEN}âœ“ Goosed is running!${NC}"
echo -e "${YELLOW}Press Ctrl+C to stop the server${NC}"
echo ""

# Keep the script running
wait
